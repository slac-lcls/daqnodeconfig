---
- hosts: "{{ variable_host | default('driver_drp') }}"
  gather_facts: false  # Moved to play level
  become: true         # Moved to play level
  vars:
    src: './roles/drp_update/files/datadev.ko_srcf'
    dest: '/usr/local/sbin/datadev.ko'
    mode: '0755'       # Fixed: valid octal mode
  tasks:
    # uploads the files in the node if not the same
    - name: load files
      ignore_errors: true
      register: artifacts_copy_status
      ansible.builtin.copy:
        src: "{{ src }}"
        dest: "{{ dest }}"
        mode: "{{ mode }}"
        backup: true

    - name: update drivers
      ignore_errors: true
      when: artifacts_copy_status.changed
      ansible.builtin.shell: |
        rmmod datadev 2>/dev/null || true
        systemctl daemon-reload
        systemctl start datadev.service
        systemctl enable datadev.service
